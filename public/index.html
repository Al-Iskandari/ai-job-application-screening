<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Candidate Screening</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

     <!-- Firebase compat build -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <!-- Firebase Config and Init -->
    <script>
        // === Your Firebase Config (safe to expose in frontend) ===
        const firebaseConfig = {
          apiKey: "AIzaSyDQj3Gh94lYYyZ8oKzmYTXZ8zH8uZnHPdI",
          authDomain: "smartmenu-63146.firebaseapp.com",
          databaseURL: "https://smartmenu-63146.firebaseio.com",
          projectId: "smartmenu-63146",
          storageBucket: "smartmenu-63146.firebasestorage.app",
          messagingSenderId: "663050950155",
          appId: "1:663050950155:web:7e7019966aa47fe1b6590e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        console.log("‚úÖ Firebase initialized");
    </script>

    <!-- Alpine.js -->
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
  </head>

  <body class="bg-gray-50 min-h-screen">
    <div
      x-data="app()"
      x-init="init()"
      class="max-w-3xl mx-auto mt-10 bg-white shadow rounded-lg p-8 space-y-10"
    >
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">AI Screening ‚Äî Dashboard</h1>
        <div class="flex items-center space-x-4">
          <button
            x-show="!isSignedIn"
            @click="signIn()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Sign in with Google
          </button>

          <div class="text-sm" x-show="isSignedIn">
            <div>Signed in as <strong x-text="userEmail"></strong></div>
            <button
              @click="signOutUser()"
              class="mt-1 bg-red-500 text-white px-3 py-1 rounded text-sm"
            >
              Sign out
            </button>
          </div>
        </div>
      </header>

      <!-- =======================
           UPLOAD SECTION
      ======================== -->
      <section class="space-y-4 border-b pb-6">
        <h2 class="text-lg font-semibold text-gray-700">
          üìÑ Upload Candidate Files
        </h2>

        <!-- CV Upload -->
        <div>
          <label class="block mb-1 font-medium">CV (PDF)</label>
          <input
            type="file"
            accept="application/pdf"
            @change="selectFile($event, 'cv')"
            class="block w-full text-sm border border-gray-300 rounded p-2"
          />

          <template x-if="progress.cv > 0">
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  class="bg-blue-600 h-2 rounded-full transition-all"
                  :style="`width: ${progress.cv}%`"
                ></div>
              </div>
              <p class="text-sm text-gray-600 mt-1">
                Uploading CV... <span x-text="progress.cv"></span>%
              </p>
            </div>
          </template>
        </div>

        <!-- Project Report Upload -->
        <div>
          <label class="block mb-1 font-medium">Project Report (PDF)</label>
          <input
            type="file"
            accept="application/pdf"
            @change="selectFile($event, 'project')"
            class="block w-full text-sm border border-gray-300 rounded p-2"
          />

          <template x-if="progress.project > 0">
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  class="bg-green-600 h-2 rounded-full transition-all"
                  :style="`width: ${progress.project}%`"
                ></div>
              </div>
              <p class="text-sm text-gray-600 mt-1">
                Uploading Project... <span x-text="progress.project"></span>%
              </p>
            </div>
          </template>
        </div>

        <button
          @click="uploadFiles"
          class="mt-4 px-5 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 disabled:opacity-50"
          :disabled="uploading || (!files.cv && !files.project)"
        >
          Upload Files
        </button>

        <template x-if="candidateId">
          <div
            class="p-3 bg-green-100 text-green-700 rounded mt-3 text-center font-medium"
          >
            ‚úÖ Candidate Uploaded! ID:
            <span x-text="candidateId" class="font-mono"></span>
            <span x-text="message" class="text-sm block mt-1"></span>
          </div>
        </template>

        <template x-if="error">
          <p class="text-red-600 mt-2 text-sm font-medium" x-text="error"></p>
        </template>
      </section>

    <!-- ========================= EVALUATION SECTION ========================= -->
      <section class="space-y-4">
        <h2 class="text-lg font-semibold text-gray-700">‚öôÔ∏è Start Evaluation</h2>

        <div>
          <label class="block mb-1 font-medium">Job Title</label>
          <input
            type="text"
            x-model="jobTitle"
            placeholder="e.g. Frontend Developer"
            class="w-full border border-gray-300 rounded p-2"
          />
        </div>

        <div>
          <label class="block mb-1 font-medium">Select Candidate</label>
          <select
            x-model="selectedCandidate"
            @focus="getCandidates()"
            class="w-full border border-gray-300 rounded p-2"
          >
            <option value="">-- Choose a Candidate --</option>
            <template x-for="cand in candidates" :key="cand.id">
              <option :value="cand.id" x-text="cand.id"></option>
            </template>
          </select>
        </div>

        <button
          @click="startEvaluation"
          class="px-5 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 disabled:opacity-50"
          :disabled="!jobTitle || !selectedCandidate || evaluating"
        >
          Start Evaluation
        </button>

        <!-- üïì Live Evaluation Status -->
        <template x-if="evaluating">
          <div class="mt-4 p-4 border rounded bg-gray-50">
            <p class="font-medium text-gray-700 mb-3">
              ‚è≥ Evaluation in progress ‚Äî refreshing every 5 seconds
            </p>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-3 mb-3 overflow-hidden">
              <div
                class="bg-green-600 h-3 transition-all duration-500"
                :style="`width: ${evalProgress}%`"
              ></div>
            </div>

            <p class="text-sm text-gray-600 mb-3">
              Current Stage:
              <span class="font-medium text-blue-700" x-text="currentStage"></span>
              (<span x-text="evalProgress"></span>%)
            </p>

            <!-- Step Tracker with Color Badges -->
            <ul class="space-y-1 text-sm">
              <template x-for="(step, index) in evalSteps" :key="index">
                <li class="flex items-center justify-between">
                  <span x-text="step.name" class="text-gray-700"></span>
                  <span
                    class="px-2 py-0.5 rounded-full text-xs font-medium"
                    :class="{
                      'bg-green-100 text-green-700 border border-green-300':
                        step.status === 'done',
                      'bg-yellow-100 text-yellow-700 border border-yellow-300':
                        step.status === 'processing',
                      'bg-gray-100 text-gray-600 border border-gray-300':
                        step.status === 'processing',
                      'bg-red-100 text-red-700 border border-red-300':
                        step.status === 'failed',
                    }"
                    x-text="
                      step.status === 'done'
                        ? 'Done'
                        : step.status === 'processing'
                        ? 'processing'
                        : step.status === 'failed'
                        ? 'Failed'
                        : 'Pending'
                    "
                  ></span>
                </li>
              </template>
            </ul>
          </div>
        </template>

        <!-- ‚ùå Error -->
        <template x-if="evalError">
          <p class="text-red-600 mt-2 text-sm font-medium" x-text="evalError"></p>
        </template>

        <!-- ‚úÖ Final Result -->
        <template x-if="evaluationResult">
          <div class="mt-4 p-4 border rounded bg-gray-50">
            <h3 class="font-semibold text-gray-700 mb-2">üß† Evaluation Result</h3>
            <pre
              class="bg-white border text-sm rounded p-3 overflow-x-auto"
              x-text="JSON.stringify(evaluationResult, null, 2)"
            ></pre>
          </div>
        </template>
      </section>
    </div>
    <!-- Firebase SDK -->
    <script>
      // === Alpine.js App Logic ===
      function app() {
        return {
          userEmail: "",
          idToken: null,
          isSignedIn: false,
          files: { cv: null, project: null },
          progress: { cv: 0, project: 0 },
          uploading: false,
          candidateId: "",
          message: "",
          error: "",
          jobTitle: "",
          candidates: [],
          selectedCandidate: "",
          evaluating: false,
          evalError: "",
          evaluationResult: null,
          evalProgress: 0,
          currentStage: "Initializing",
          pollingTimer: null,
          evalSteps: [
            { name: "Download files and extract text", status: "pending" },
            { name: "Parse text from PDF buffers", status: "pending" },
            { name: "Generate embeddings", status: "pending" },
            { name: "Retrieve context from Zilliz", status: "pending" },
            { name: "Call Gemini for CV evaluation", status: "pending" },
            { name: "Call Gemini for Project evaluation", status: "pending" },
            { name: "Summarize evaluation", status: "pending" },
            { name: "Combine evaluations", status: "pending" },
            { name: "Sanitize Gemini response", status: "pending" },
            { name: "Save evaluation to Firestore", status: "pending" },
          ],

          async init() {
            // Listen for Firebase Auth state changes
            firebase.auth().onAuthStateChanged(async (user) => {
              if (user) {
                this.userEmail = user.email;
                this.isSignedIn = true;
                this.idToken = await user.getIdToken(true);
                localStorage.setItem("firebase_token", this.idToken);
                console.log("Signed in as", this.userEmail);
              } else {
                this.isSignedIn = false;
                this.userEmail = "";
                this.idToken = null;
                localStorage.removeItem("firebase_token");
              }
            });
          },

          async signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
              const result = await firebase.auth().signInWithPopup(provider);
              const user = result.user;
              this.userEmail = user.email;
              this.isSignedIn = true;
              this.idToken = await user.getIdToken(true);
              localStorage.setItem("firebase_token", this.idToken);
            } catch (error) {
              console.error("Login failed:", error);
              alert("Login failed: " + error.message);
            }
          },

          async signOutUser() {
            await firebase.auth().signOut();
            this.isSignedIn = false;
            this.userEmail = "";
            this.idToken = null;
            localStorage.removeItem("firebase_token");
          },

          // === Your existing logic below ===
          selectFile(e, type) {
            this.files[type] = e.target.files[0];
          },

          async uploadFiles() {
            this.error = "";
            this.uploading = true;
            this.message = "";
            let candidateId = this.candidateId || null;
            
            try {
              for (const [type, file] of Object.entries(this.files)) {
                if (!file) continue;

                // Step 1: Ask backend for signed URL
                const res = await fetch("/api/upload", {
                  method: "POST",
                  headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${this.idToken}`,
                  },
                  body: JSON.stringify({
                    fileName: file.name,
                    fileType: file.type,
                    candidateId, // Pass existing candidateId if available
                  }),
                });

                if (!res.ok) {
                  const errorData = await res.json();
                  throw new Error(`Failed to get signed URL for ${type} file, status: ${errorData.message}`);
                }

                const { signedUrl, storagePath, candidateId: newCandidateId } = await res.json();

                // Use new candidateId if provided by backend
                if(!candidateId){
                  candidateId = newCandidateId;
                  this.candidateId = newCandidateId;
                }

                // Step 2: Upload file to Supabase using signed URL
                const uploadRes = await fetch(signedUrl, {
                  method: "PUT",
                  headers: {
                    "Content-Type": file.type,
                    "Authorization": `Bearer ${this.idToken}`,
                  },
                  body: file,
                });

                if (!uploadRes.ok) {
                  const errorData = await uploadRes.json();
                  throw new Error(`Failed to upload ${type} file, status: ${errorData.message} the signedUrl is ${signedUrl}`);
                }

                this.progress[type] = 100;

                // Step 3: Confirm upload (metadata)
                const confirmRes = await fetch("/api/confirm-upload", {
                  method: "POST",
                  headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${this.idToken}`,
                  },
                  body: JSON.stringify({
                    storagePath,
                    candidateId,
                    fileCategory: type,
                  }),
                });

                const confirmData = await confirmRes.json();
                if (!confirmData.success) {
                  throw new Error(`Failed to confirm ${type} upload: ${confirmData.message}`);
                }

                this.message = confirmData.message;
              }

              // Add candidate to dropdown if not already added
              if (!this.candidates.some(c => c.id === candidateId)) {
                this.candidates.push({ id: candidateId });
              }

              this.uploading = false;
            } catch (err) {
              console.error(err);
              this.error = err.message;
              this.uploading = false;
            }
          },

          async getCandidates() {
            try {
              const res = await fetch("/api/candidates", {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${this.idToken}`,
                },
              }); 
              const candidates = await res.json();

              console.log(`Got ${candidates.length} candidates`, candidates);
              
              for (const candidate of candidates) {
                if (!this.candidates.some(c => c.id === candidate.candidate_id)) {
                  this.candidates.push({ id: candidate.candidate_id });
                }
              }
            } catch (err) {
              console.warn("Failed to get candidates:", err);
            }
          },

          async startEvaluation() {
            this.evaluating = true;
            this.evalError = "";
            this.evaluationResult = null;
            this.evalProgress = 0;
            this.currentStage = "Initializing";
            this.evalSteps.forEach((s) => (s.status = "pending"));

            try {
              // Start evaluation request
              const res = await fetch("/api/evaluate", {
                method: "POST",
                headers: { 
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${this.idToken}`,
                 },
                body: JSON.stringify({
                  candidateId: this.selectedCandidate,
                  jobTitle: this.jobTitle,
                }),
              });

              if (!res.ok) throw new Error("Failed to start evaluation");
              const { candidateId: evalId } = await res.json();

              // Begin polling
              this.pollResult(evalId);
            } catch (err) {
              this.evalError = err.message;
              this.evaluating = false;
            }
          },

          /**
           * Polls the evaluation result every 5 seconds
           * @param {string} evalId - Unique identifier for the evaluation
           */
          async pollResult(evalId) {
            this.pollingTimer = setInterval(async () => {
              try {
                const res = await fetch(`/api/result/${evalId}`, {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${this.idToken}`,
                  },
                });

                if(res.status === 401) {
                  this.message = "You are not signed in";
                  return null;
                }

                if (!res.ok) throw new Error("Polling failed");

                const data = await res.json();

                // Update UI dynamically from backend response
                if (data.stage) this.currentStage = data.stage;
                if (data.progress !== undefined) this.evalProgress = data.progress;

                // Update step statuses
                this.evalSteps.forEach((step) => {
                  if (step.name === data.stage) step.status = "processing";
                  else if (
                    this.evalSteps.findIndex((s) => s.name === data.stage) >
                    this.evalSteps.findIndex((s) => s.name === step.name)
                  )
                    step.status = "done";
                  else if (data.status === "failed") step.status = "failed";
                  else step.status = "pending";
                });

                if (data.status === "completed" && data.result) {
                  clearInterval(this.pollingTimer);
                  this.evaluationResult = data.result;
                  this.evaluating = false;
                  this.evalProgress = 100;
                  this.currentStage = "Completed";
                  this.evalSteps.forEach((s) => (s.status = "done"));
                } else if (data.status === "failed") {
                  clearInterval(this.pollingTimer);
                  this.evalError = "Evaluation failed. Try again.";
                  this.evaluating = false;
                  const failedStep = this.evalSteps.find((s) => s.name === data.stage);
                  if (failedStep) failedStep.status = "failed";
                }
              } catch (err) {
                console.error("Polling error:", err);
              }
            }, 5000);
          }
        };
      };
    </script>
  </body>
</html>
