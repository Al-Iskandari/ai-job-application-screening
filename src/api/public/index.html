<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Candidate Screening</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
  </head>

  <body class="bg-gray-50 min-h-screen">
    <div
      x-data="app()"
      class="max-w-3xl mx-auto mt-10 bg-white shadow rounded-lg p-8 space-y-10"
    >
      <h1 class="text-2xl font-bold text-gray-800 text-center">
        AI Candidate Screening System
      </h1>

      <!-- =======================
           UPLOAD SECTION
      ======================== -->
      <section class="space-y-4 border-b pb-6">
        <h2 class="text-lg font-semibold text-gray-700">
          üìÑ Upload Candidate Files
        </h2>

        <!-- CV Upload -->
        <div>
          <label class="block mb-1 font-medium">CV (PDF)</label>
          <input
            type="file"
            accept="application/pdf"
            @change="selectFile($event, 'cv')"
            class="block w-full text-sm border border-gray-300 rounded p-2"
          />

          <template x-if="progress.cv > 0">
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  class="bg-blue-600 h-2 rounded-full transition-all"
                  :style="`width: ${progress.cv}%`"
                ></div>
              </div>
              <p class="text-sm text-gray-600 mt-1">
                Uploading CV... <span x-text="progress.cv"></span>%
              </p>
            </div>
          </template>
        </div>

        <!-- Project Report Upload -->
        <div>
          <label class="block mb-1 font-medium">Project Report (PDF)</label>
          <input
            type="file"
            accept="application/pdf"
            @change="selectFile($event, 'project')"
            class="block w-full text-sm border border-gray-300 rounded p-2"
          />

          <template x-if="progress.project > 0">
            <div class="mt-2">
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  class="bg-green-600 h-2 rounded-full transition-all"
                  :style="`width: ${progress.project}%`"
                ></div>
              </div>
              <p class="text-sm text-gray-600 mt-1">
                Uploading Project... <span x-text="progress.project"></span>%
              </p>
            </div>
          </template>
        </div>

        <button
          @click="uploadFiles"
          class="mt-4 px-5 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 disabled:opacity-50"
          :disabled="uploading || (!files.cv && !files.project)"
        >
          Upload Files
        </button>

        <template x-if="candidateId">
          <div
            class="p-3 bg-green-100 text-green-700 rounded mt-3 text-center font-medium"
          >
            ‚úÖ Candidate Uploaded! ID:
            <span x-text="candidateId" class="font-mono"></span>
          </div>
        </template>

        <template x-if="error">
          <p class="text-red-600 mt-2 text-sm font-medium" x-text="error"></p>
        </template>
      </section>

      <!-- =======================
           EVALUATION SECTION
      ======================== -->
      <section class="space-y-4">
        <h2 class="text-lg font-semibold text-gray-700">
          ‚öôÔ∏è Start Evaluation
        </h2>

        <div>
          <label class="block mb-1 font-medium">Job Title</label>
          <input
            type="text"
            x-model="jobTitle"
            placeholder="e.g. Frontend Developer"
            class="w-full border border-gray-300 rounded p-2"
          />
        </div>

        <div>
          <label class="block mb-1 font-medium">Select Candidate</label>
          <select
            x-model="selectedCandidate"
            class="w-full border border-gray-300 rounded p-2"
          >
            <option value="">-- Choose a Candidate --</option>
            <template x-for="cand in candidates" :key="cand.id">
              <option :value="cand.id" x-text="cand.id"></option>
            </template>
          </select>
        </div>

        <button
          @click="startEvaluation"
          class="px-5 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 disabled:opacity-50"
          :disabled="!jobTitle || !selectedCandidate || evaluating"
        >
          Start Evaluation
        </button>

        <template x-if="evaluating">
          <div class="text-sm text-gray-700 mt-2">
            ‚è≥ Evaluation in progress... checking every 5 seconds.
          </div>
        </template>

        <template x-if="evalError">
          <p class="text-red-600 mt-2 text-sm font-medium" x-text="evalError"></p>
        </template>

        <template x-if="evaluationResult">
          <div class="mt-4 p-4 border rounded bg-gray-50">
            <h3 class="font-semibold text-gray-700 mb-2">
              üß† Evaluation Result
            </h3>
            <pre
              class="bg-white border text-sm rounded p-3 overflow-x-auto"
              x-text="JSON.stringify(evaluationResult, null, 2)"
            ></pre>
          </div>
        </template>
      </section>
    </div>

    <script>
      function app() {
        return {
          files: { cv: null, project: null },
          progress: { cv: 0, project: 0 },
          uploading: false,
          candidateId: "",
          error: "",
          jobTitle: "",
          candidates: [],
          selectedCandidate: "",
          evaluating: false,
          evalError: "",
          evaluationResult: null,
          pollingTimer: null,

          selectFile(e, type) {
            this.files[type] = e.target.files[0];
          },

          async uploadFiles() {
            this.error = "";
            this.uploading = true;
            try {
              for (const [type, file] of Object.entries(this.files)) {
                if (!file) continue;

                // Step 1: Ask backend for signed URL
                const res = await fetch("/api/upload-url", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    fileName: file.name,
                    fileType: file.type,
                  }),
                });

                const { signedUrl, storagePath, candidateId } = await res.json();
                this.candidateId = candidateId;

                // Step 2: Upload directly to Firebase Storage
                const uploadRes = await fetch(signedUrl, {
                  method: "PUT",
                  headers: {
                    "Content-Type": file.type,
                    "x-goog-meta-uploadedBy": "web-client",
                  },
                  body: file,
                });

                if (!uploadRes.ok)
                  throw new Error(`Failed to upload ${type} file`);

                this.progress[type] = 100;

                // Step 3: Confirm upload (metadata)
                await fetch("/api/confirm-upload", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    storagePath,
                    candidateId,
                    fileType: type,
                  }),
                });
              }

              // Add candidate to selection
              this.candidates.push({ id: this.candidateId });
              this.uploading = false;
            } catch (err) {
              console.error(err);
              this.error = err.message;
              this.uploading = false;
            }
          },

          async startEvaluation() {
            this.evaluating = true;
            this.evalError = "";
            this.evaluationResult = null;

            try {
              // Start evaluation request
              const res = await fetch("/api/evaluate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  candidateId: this.selectedCandidate,
                  jobTitle: this.jobTitle,
                }),
              });

              if (!res.ok) throw new Error("Failed to start evaluation");
              const { id: evalId } = await res.json();

              // Begin polling
              this.pollResult(evalId);
            } catch (err) {
              this.evalError = err.message;
              this.evaluating = false;
            }
          },

          async pollResult(evalId) {
            this.pollingTimer = setInterval(async () => {
              try {
                const res = await fetch(`/api/result/${evalId}`);
                if (!res.ok) throw new Error("Polling failed");

                const data = await res.json();

                if (data.status === "completed") {
                  clearInterval(this.pollingTimer);
                  this.evaluationResult = data.result;
                  this.evaluating = false;
                } else if (data.status === "failed") {
                  clearInterval(this.pollingTimer);
                  this.evalError = "Evaluation failed. Try again.";
                  this.evaluating = false;
                }
              } catch (err) {
                console.error("Polling error:", err);
              }
            }, 5000);
          },
        };
      }
    </script>
  </body>
</html>
